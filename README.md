# Exploitation

An exploit (from the English verb to exploit, meaning "to use something to one’s own advantage") is a piece of software, a chunk of data, or a sequence of commands that takes advantage of a bug or vulnerability to cause unintended or unanticipated behavior to occur on computer software, hardware, or something electronic (usually computerized). Such behavior frequently includes things like gaining control of a computer system, allowing privilege escalation, or a denial-of-service (DoS or related DDoS) attack.

Each attacks usually are required a custom-prepared payloads and attackers should adjust it, however some tools can lead us. Here is some examples what we can use during our security tests:

* __Exploit Frameworks__: Metasploit, Core Impact, Cobalt Strike, etc. These tools already have some previously discovered exploits and some common tool, such as shell listeners, local privilege escalation, hard-coded password controls, etc.
* __Attack Proxies__: Burp Suite, OWASP ZAP, etc. They give us chance to manipulate HTTP header parameters. Attacks can setup a proxy to intercept HTTP calls. That means, we can interact with any parameters and bypass client-side controls for our payload injections.
* __Vulnerability scanners__: Netsparker, Acunetix, Nessus, OpenVAS can automatically detect some common configuration mistakes and previously reported security issues.


## Web / API attacks
Web / API attacks are related with HTTP service. Attackers try to inject malicious commands, detect applications and versions, discovery hidden contents, getting touch with operating system, left-over files, backup files and configuration files, etc.

OWASP is a great source for application security and they made a TOP 10 list to emphasize most common  attacks. [The OWASP Top 10](https://owasp.org/www-project-top-ten/) is a standard awareness document for developers and web application security. It represents a broad consensus about the most critical security risks to web applications.

Some common attacks and explanations:

* Directory brute force may reveal some hidden content of the web service, such as default pages, version details, backend files which are not intended to expose end users, etc. dirb, dirbuster, gobuster, wfuzz, etc. can be used for this purpose.

	Code Example:
	```
	$ dirb http://URL/ PossibleFilesList.txt
	```

	The important part is in here:
    * These tools do not spider the target system and only check for files/folders in argument we provided (PossibleFilesList.txt). 
    * We still need to handle session cookies and tokens. Otherwise, the test will be performed over unauthenticated session, but it is still acceptable, because HTTP 403 may indicate the requested URL exists.
    * And we need to analysis out-come of the scan and know common HTTP responses and the service behaviors: 
        - __HTTP 200__: The file is accessible
        - __HTTP 302__: The request is redirected to login page.
        - __HTTP 403__: The page is not accessible due to lack of permission or authorization.
        - __HTTP 404__: The file does not exist.
    
    These codes are common HTTP responses, but some services act in a different way. For example, if the requested URL does not exist, the service replies with a HTTP 200 and indicates it with a text, instead of responding with a HTTP 404 code.
    
    Default pages, backup files and application versions can be very useful: 
    * Default pages may lead us login pages, default configurations, users and credentials, which might be publicly available to anyone.
    * Backup files may contain application credentials. We can try to restore it, check for credentials and see what is going on the application's backend.
    * Also application versions are important, because attackers can search for publicly known security issues: https://github.com, https://www.exploit-db.com and search engines are great sources for this search. Additionally, they can download same versions of the applications and simulate the target environment to find zero days. 

* A SQL injection attack consists of insertion or “injection” of a SQL query via the input data from the client to the application. A successful SQL injection exploit can read sensitive data from the database, modify database data (Insert/Update/Delete), execute administration operations on the database (such as shutdown the DBMS), recover the content of a given file present on the DBMS file system and in some cases issue commands to the operating system. SQL injection attacks are a type of injection attack, in which SQL commands are injected into data-plane input in order to affect the execution of predefined SQL commands.

  Some common SQLi control payloads:

  ```
  http://URL?id=1337 or 1=1 -- 	//should always return True
  http://URL?id=1337 or 1=2 -- 	
  ```

  Also there is a very famous tool for that kind of attacks: 'sqlmap'. It can be very useful and time saver:

  ```
  $ sqlmap -u 'http://URL/?id=1337' -p 'id' --dbs
  ```
  If the 'id' param is vulnerable for SQLi attacks, 'sqlmap' performs various attacks and retrieves database tables, columns, contents, etc.


* Command injection is an attack in which the goal is execution of arbitrary commands on the host operating system via a vulnerable application. Command injection attacks are possible when an application passes unsafe user supplied data (forms, cookies, HTTP headers etc.) to a system shell. In this attack, the attacker-supplied operating system commands are usually executed with the privileges of the vulnerable application. Command injection attacks are possible largely due to insufficient input validation.
It is a very serious attack vector because attackers can interact with target OS and run arbitrary commands. 
There are a couple different ways to perform that kind of attacks:
    * Uploading malicious files: Attackers can upload malicious executable files to target system and execute it over URL calls.
    * Modifying target system files: Web service template files can be a good target. Attacker may modify email template, error pages, etc.
    * Injecting commands: Some application may require to run OS commands and attackers try to inject extra commands. The example below, takes 'filename' parameter and remove the argument from operating system. However, shell escapes like '&, |, ;' may lead to execute '$ rm tmp.txt;id' all together.
		```
		Http Call:
		  http://URL/removeFile.php?filename=tmp.txt;id
					
		removeFile.php content:
		<?php
		  print("Please specify the name of the file to delete");
		  print("<p>");
		  $file=$_GET['filename'];
		  system("rm $file");
		?>
		```

  All these commands will be run with the target service privilege and that shows again the service should run with minimum privileges to reduce attack surfaces.


## Database services
Database services play an important role for applications and they should be isolated from user accessible networks. Otherwise, they will become an open target for attackers and that may lead to serious consequence. Some common database systems are MySQL, PostgreSQL, MSSql, Oracle, etc. 

Beside SQLi attacks, intruders can also target database services themself. Some common attacks:
There are a couple different ways to perform that kind of attacks:

* Attackers can try login attempts, if the service host:port is accessible. Default and guessable credentials will be first target. Some example of brute force commands:

```
  $ ncrack -v -iL TargetIPAddresses.txt --user root -P passwords.txt -p PostgreSQL CL=1
  $ hydra -L userNames.txt -P userPass.txt <IP> mssql
  $ nmap --script oracle-brute -p 1521 --script-args oracle-brute.sid=ORCL <ip>
  $ nmap -p 27017 <ip> --script mongodb-brute
```

* Application banners can be helpful to expose running versions and attackers can search reported vulnerabilities. Even simulate the target environment to find zero days. 
* And insecure algorithms or protocols may also cause traffic monitoring, replay attacks, etc. Best practices should be followed for data-at-rest, data-in-transit and data-in-use.


## Other Application Services
Other Application Services also help attackers to gain access, due to vulnerable versions, missing configuration or support insecure protocols. If the service is exposed to the network, it can be discovered with network scanning tools, such as NMAP. It may give attackers chance to understand the target system better for further exploitation. 

Version vulnerabilities and brute-force attacks are also applicable for other services as well. Beside that, some other common application services and attacks:

* FTP can be used for file transfer, however it communicates over a plain text protocol. Attackers can poison the client's network to monitor her/his traffic. Default and guessable accounts give attackers chance to access target system and transfer files.

	```
	$ nmap -sV -sC <target>
	```

* SMTP is a mail transfer protocol and it can be a good target for password reset or impersonation attacks. Mail open relay feature may allow anyone to send emails without providing credentials. 

	```
	$ nmap -sTV -p 25,465,587 <host>
	$ nmap --script smtp-open-relay.nse [--script-args smtp-open-relay.domain=<domain>,smtp-open-relay.ip=<address>,...] -p 25,465,587 <host>
	$ nmap --script smtp-enum-users.nse [--script-args smtp-enum-users.methods={EXPN,...},...] -p 25,465,587 <host>
	```
  
* Network Shares give users to access some common paths and weak access permissions may expose its content to intruders. Network shares and file permissions should always have a proper access roles.

	```
	$ nmap --script smb-enum-shares.nse -p445 <host>
	$ sudo nmap -sU -sS --script smb-enum-shares.nse -p U:137,T:139 <host>
	```

## User management
User management is also another important part of secure design. All users should have minimum roles, a proper passwords policy and all services should have least privileges. 

Some example of bad practices: 

* Running services with administrative accounts, for example running database or web service with admin privilege. Any code injection will double the damage if the service runs with a high privilege account. Security best practices recommend to use minimum privilege with a restricted environment. 
* Using same accounts/credentials for other services is also not part of security best practices. For example, using same password for database and operating system increase the attack surface. That means, somehow if attacker find a way to obtain the credentials, the she/he will be able to login both systems.
* Using default/basic guessable passwords is another security precaution at first step. Each account should have a proper password policy and cycle. 

## Brute force attack
Brute force attack consists of an attacker submitting many passwords or passphrases with the hope of eventually guessing correctly. The attacker systematically checks all possible passwords and passphrases until the correct one is found. It is a very time consuming attack and trying all possible combinations may take a very long time. So attackers may generate a little bit smart dictionary list to try, for example: years (2020, 2021, 2022), months (May, June, July), default passwords, location and company related information, etc.

Some common tools and protocols:
* Burp Suite and Zap Proxy can be used for credential and directory brute forcing. It only supports HTTP protocol and does not work for other network protocols, such as ftp, ssh, smb, etc.
* hydra, nmap, ncrack, medusa, etc. some tools for brute-forcing. They support various of network protocols and they do quite similar jobs.
* We may need to brute-force password hashes and for that cases john the ripper, hashcat, etc.

Any services exposed to end-users look suspicious for that kind of attacks and the target system should restrict user attempts with implementing:

* A proper password policy: strong and proper length
* Lockout policy: lock user accounts temporary or permanently, if suspicious attempts happen.
* Captcha: It might be a good option to prevent bulk requests in a short amount of time, but it should be complex enough to not solve easily.
* Limiting request numbers: ban requests or give delayed responses.
* Monitor suspicious activities: monitor user accounts and activates to detect intrusive behaviors. 
* Two-factor authentication: Users should approve her/his own requests through a separate communication channel. This out-of-band authentication approval method can be something you know, something you have, and something you are.
